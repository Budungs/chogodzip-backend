<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.kb.room.mapper.RoomMapper">

    <!-- Room Result Map 정의 -->
    <resultMap id="roomResultMap" type="com.kb.room.dto.Room">
        <id property="roomId" column="room_id"/>
        <result property="userId" column="user_id"/>
        <result property="roomCnt" column="room_cnt"/>
        <result property="roomName" column="room_name"/>
        <result property="floor" column="floor"/>
        <result property="houseTypeCd" column="house_type_cd"/>
        <result property="houseTypeNms" column="house_type_nms"/>
        <result property="genderCd" column="gender_cd"/>
        <result property="tags" column="tags"/>
        <result property="imgId" column="img_id"/>
        <result property="roomAddr" column="room_addr"/>
        <result property="roomAddrFl" column="room_addr_fl"/>
        <result property="roomLat" column="room_lat"/>
        <result property="roomLong" column="room_long"/>
        <result property="depositMax" column="deposit_max"/>
        <result property="depositMin" column="deposit_min"/>
        <result property="priceMax" column="price_max"/>
        <result property="priceMin" column="price_min"/>
        <result property="isSoldOut" column="IS_SOLD_OUT"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
    </resultMap>

    <!-- 위치를 기준으로 고시원을 찾는 쿼리 -->
    <select id="findGosiwonsByLocation" resultMap="roomResultMap">
    <![CDATA[
        SELECT *,
               (6371 * acos(cos(radians(#{lat}))
                                * cos(radians(room_lat))
                                * cos(radians(room_long) - radians(#{lng}))
                   + sin(radians(#{lat}))
                                * sin(radians(room_lat)))) AS distance
        FROM dummy_oneroom_tbl
        where house_type_cd IN ('HOUTP00001', 'HOUTP00003')
        HAVING distance < 1
        ORDER BY distance;

        ]]>
    </select>

    <!--  모든 부동산 데이터 조회  -->
    <select id="findAll" resultType="com.kb.room.vo.RoomTemp">
       <![CDATA[
            SELECT * FROM ROOM
        ]]>
    </select>

    <!--  부동산 작성  -->
    <insert id="saveRoom" parameterType="com.kb.room.vo.RoomTemp" useGeneratedKeys="true" keyProperty="roomId">
        <![CDATA[
            INSERT INTO ROOM (USER_ID, ROOM_LAT, ROOM_LONG, THUMBNAIL, CAN_LOAN, UPDATED_AT, CREATED_AT)
            VALUES (#{userId}, #{roomLat}, #{roomLong}, #{thumbnail}, #{canLoan}, NOW(), NOW())
        ]]>

        <selectKey keyProperty="roomId" resultType="long" order="AFTER">
            SELECT LAST_INSERT_ID()
        </selectKey>
    </insert>

    <!--  고시원 작성  -->
<!--    <insert id="saveGosiwon" parameterType="com.kb.room.dto.request.GosiwonPostDTO" useGeneratedKeys="true" keyProperty="gswId">-->
<!--        <![CDATA[-->
<!--            INSERT INTO GOSIWON (ROOM_ID, TITLE, POSTCODE, ADDRESS, DETAIL_ADDRESS, PRICE_MIN, PRICE_MAX, DEPOSIT_MIN, DEPOSIT_MAX, MAINTENANCE_FEE-->
<!--            , PRIVATE_FACILITIES, SERVICES, LANGUAGES, ETC, DESCRIPTION, GENDER_LIMIT, TYPE, CONTRACT_MIN, AGE_MAX, AGE_MIN-->
<!--            , FACILITY_HEATING, FACILITY_COOLING, FACILITY_LIFE, FACILITY_SECURITY, BUILDING_TYPE, CAN_PARKING, HAS_ELEVATOR-->
<!--            , IS_SOLD_OUT)-->
<!--            VALUES-->
<!--            (#{roomId}, #{title}, #{postcode}, #{})-->
<!--        ]]>-->
<!--    </insert>-->

</mapper>
